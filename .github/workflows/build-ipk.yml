name: Build IPK

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master

jobs:
  build-ipk:
    runs-on: ubuntu-latest

    steps:
      - name: Clone Repository
        uses: actions/checkout@v3
        with:
          name: luci-app-adguardhome-ipk
          path: |
            openwrt-sdk/bin/packages/x86_64/luci-app-adguardhome*.ipk

      - name: Setup OpenWrt SDK
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential libncurses5-dev gawk gettext unzip file libssl-dev python3 git zlib1g-dev sudo quilt
          git clone https://github.com/openwrt/openwrt.git openwrt-sdk
          cd openwrt-sdk
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Add luci-app-adguardhome package
        run: |
          cd openwrt-sdk/package
          ln -s $GITHUB_WORKSPACE/luci-app-adguardhome .
          cd ..

      - name: Configure build
        run: |
          cd openwrt-sdk
          make defconfig

      - name: Build IPK
        run: |
          cd openwrt-sdk
          make package/luci-app-adguardhome/compile V=s

      - name: 调试构建输出
        run: |
          ls -R openwrt-sdk/bin/packages

      - name: Debug IPK Path
        run: |
          find openwrt-sdk/bin/packages -name "luci-app-adguardhome*.ipk"

      - name: 上传 IPK 文件
        uses: actions/upload-artifact@v3
        with:
          name: luci-app-adguardhome-ipk
          path: |
            openwrt-sdk/bin/packages/**/*.ipk
